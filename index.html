<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Guess the English Word</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 50px auto;
    padding: 20px;
    text-align: center;
    background: #f5f5f5;
  }
  input {
    font-size: 20px;
    padding: 10px;
    width: 80%;
    margin-bottom: 15px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  button {
    padding: 10px 20px;
    font-size: 20px;
    border-radius: 6px;
    border: none;
    background: #007bff;
    color: white;
    cursor: pointer;
    margin: 5px;
  }
  button:disabled {
    background: #aaa;
    cursor: not-allowed;
  }
  p.definition {
    font-size: 20px;
    margin-bottom: 10px;
    min-height: 80px;
    color: #333;
  }
  /* Hint tiles */
  #hintTiles {
    margin: 10px 0 20px;
    display: flex;
    justify-content: center;
    gap: 8px;
  }
  .tile {
    width: 36px;
    height: 36px;
    line-height: 36px;
    border: 2px solid #999;
    font-weight: bold;
    font-size: 24px;
    color: transparent;
    background: white;
    user-select: none;
    border-radius: 6px;
    transition: background-color 0.3s, color 0.3s;
  }
  .tile.revealed {
    color: black;
    border-color: #007bff;
    background-color: #d0e7ff;
  }
  p.message {
    font-size: 20px;
    min-height: 30px;
  }
  p.timer {
    font-size: 18px;
    color: #d6336c;
    margin-bottom: 15px;
  }
</style>
</head>
<body>
  <h1>Guess the English Word</h1>
  <label for="dictSelect">Dictionary:</label>
  <select id="dictSelect" style="font-size:16px;padding:6px;margin-bottom:12px;">
    <option value="dictionary.json">Full</option>
    <option value="dictionary.simple.json" selected>Simple</option>
  </select>
  <p class="definition" id="definition"></p>
  
  <!-- Hint tiles container -->
  <div id="hintTiles"></div>

  <p class="timer" id="timer">‚è≥ Time left: 60s</p>
  <input type="text" id="guessInput" placeholder="Type your guess here" autocomplete="off" />
  <br />
  <button onclick="checkGuess()" id="checkBtn">Check Answer</button>
  <button onclick="revealAnswer()" id="revealBtn">Reveal Answer</button>
  <p class="message" id="message"></p>
  <button onclick="nextWord()" id="nextBtn" disabled>Next Word</button>

<script>
let words = [];
let currentIndex = 0;
let timerInterval;
let hintRevealInterval;
let timeLeft = 60;

const definitionEl = document.getElementById("definition");
const hintTilesEl = document.getElementById("hintTiles");
const guessInput = document.getElementById("guessInput");
const messageEl = document.getElementById("message");
const nextBtn = document.getElementById("nextBtn");
const dictSelect = document.getElementById("dictSelect");
const timerEl = document.getElementById("timer");
const checkBtn = document.getElementById("checkBtn");
const revealBtn = document.getElementById("revealBtn");

let revealedIndexes = [];

function isInsideBalancedParentheses(text, index) {
  let openParens = 0;
  for (let i = 0; i < index; i++) {
    if (text[i] === '(') openParens++;
    else if (text[i] === ')') openParens = Math.max(openParens - 1, 0);
  }
  let closeParens = 0;
  for (let i = index + 1; i < text.length; i++) {
    if (text[i] === ')') {
      closeParens++;
      break;
    } else if (text[i] === '(') {
      return false;
    }
  }
  return openParens > 0 && closeParens > 0;
}

function findValidFullStop(text, startIndex = 0) {
  let index = text.indexOf('.', startIndex);
  while (index !== -1) {
    if (!isInsideBalancedParentheses(text, index) && text[index + 1] !== ')') {
      return index;
    }
    index = text.indexOf('.', index + 1);
  }
  return -1;
}

function shortenDefinitions(definition) {
  const paragraphs = definition.split(/\n\n+/);

  const processedParts = paragraphs.map(paragraph => {
    if (/\d+\.\s/.test(paragraph)) {
      let parts = paragraph.split(/(?=\d+\.\s)/g);

      parts = parts.filter(part => {
        const numberMatch = part.match(/^(\d+)\./);
        if (!numberMatch) return false;
        const num = numberMatch[1];
        return num !== "0";
      });

      const filteredParts = [];
      let lastNum = null;
      for (const part of parts) {
        const numberMatch = part.match(/^(\d+)\./);
        if (!numberMatch) continue;
        const num = numberMatch[1];
        if (num === lastNum) continue;
        lastNum = num;
        filteredParts.push(part);
      }

      const usefulParts = filteredParts.filter(part => {
        const textWithoutNumber = part.replace(/^\d+\.\s*/, '').trim();
        return textWithoutNumber.length > 0 && /[a-zA-Z(),'"-]/.test(textWithoutNumber);
      });

      const shortenedParts = usefulParts.map(part => {
        const firstSentenceEnd = findValidFullStop(part, part.indexOf(' ') + 1);
        let text;
        if (firstSentenceEnd === -1) {
          text = part.trim();
        } else {
          text = part.slice(0, firstSentenceEnd + 1).trim();
        }

        const semicolonIndex = text.indexOf(';');
        if (semicolonIndex !== -1) {
          text = text.slice(0, semicolonIndex).trim() + '.';
        }

        return text;
      });

      return shortenedParts.join('<br>');
    } else {
      const firstSentenceEnd = findValidFullStop(paragraph);
      if (firstSentenceEnd === -1) return paragraph.trim();
      let text = paragraph.slice(0, firstSentenceEnd + 1).trim();
      const semicolonIndex = text.indexOf(';');
      if (semicolonIndex !== -1) {
        text = text.slice(0, semicolonIndex).trim() + '.';
      }
      return text;
    }
  }).filter(p => p.length > 0);

  return processedParts.join('<br>');
}

// ‚úÖ Remove any sentence containing the answer word
function removeAnswerSentences(definition, word) {
  const lowerWord = word.toLowerCase();
  const sentences = definition
    .split(/(?<=[.?!])\s+/)
    .filter(s => s.trim().length > 0);

  const filtered = sentences.filter(s => {
    const regex = new RegExp(`\\b${lowerWord}s?\\b`, "i");
    return !regex.test(s);
  });

  // if removing leaves nothing, keep original
  return filtered.length > 0 ? filtered.join(' ') : definition;
}

function loadDictionaryAndStart() {
  clearIntervals();
  const dictFile = dictSelect.value;
  fetch(dictFile)
    .then(response => {
      if (!response.ok) throw new Error("Failed to load dictionary");
      return response.json();
    })
    .then(data => {
      words = Object.entries(data).map(([word, definition]) => ({ word, definition }));
      words.sort(() => Math.random() - 0.5);
      currentIndex = 0;
      showDefinition();
    })
    .catch(error => {
      definitionEl.textContent = "‚ö†Ô∏è Could not load dictionary file.";
      console.error(error);
    });
}

dictSelect.addEventListener("change", loadDictionaryAndStart);

function showDefinition() {
  clearIntervals();
  timeLeft = 60;
  timerEl.textContent = `‚è≥ Time left: ${timeLeft}s`;
  revealedIndexes = [];

  if (!words || words.length === 0) {
    definitionEl.textContent = "No words available in the selected dictionary.";
    hintTilesEl.innerHTML = "";
    guessInput.style.display = "none";
    nextBtn.style.display = "none";
    timerEl.textContent = "";
    return;
  }

  const currentWord = words[currentIndex];
  let def = shortenDefinitions(currentWord.definition);
  def = removeAnswerSentences(def, currentWord.word); // ‚úÖ remove self-referencing sentences

  definitionEl.innerHTML = def;

  guessInput.value = "";
  guessInput.disabled = false;
  checkBtn.disabled = false;
  revealBtn.disabled = false;
  messageEl.textContent = "";
  nextBtn.disabled = true;
  guessInput.style.display = "";
  nextBtn.style.display = "";

  createHintTiles(currentWord.word);
  guessInput.focus();

  startTimer(currentWord);
  startHintReveal(currentWord.word);
}

function createHintTiles(word) {
  hintTilesEl.innerHTML = "";
  for (let i = 0; i < word.length; i++) {
    const tile = document.createElement("div");
    tile.classList.add("tile");
    tile.textContent = word[i].toUpperCase();
    hintTilesEl.appendChild(tile);
  }
}

function revealRandomLetter(word) {
  const tiles = hintTilesEl.children;
  const unrevealedIndexes = [];

  for (let i = 0; i < tiles.length; i++) {
    if (!tiles[i].classList.contains("revealed")) {
      unrevealedIndexes.push(i);
    }
  }

  if (unrevealedIndexes.length === 0) {
    clearInterval(hintRevealInterval);
    return;
  }

  const randomIndex = unrevealedIndexes[Math.floor(Math.random() * unrevealedIndexes.length)];
  tiles[randomIndex].classList.add("revealed");
  revealedIndexes.push(randomIndex);
}

function startTimer(currentWord) {
  timerInterval = setInterval(() => {
    timeLeft--;
    timerEl.textContent = `‚è≥ Time left: ${timeLeft}s`;

    if (timeLeft === 30) {
      revealRandomLetter(currentWord.word);
    }

    if (timeLeft <= 0) {
      clearIntervals();
      guessInput.disabled = true;
      checkBtn.disabled = true;
      revealBtn.disabled = true;
      messageEl.style.color = "#d6336c";
      messageEl.textContent = `‚è∞ Time's up! The correct answer was "${currentWord.word}".`;
      nextBtn.disabled = false;
    }
  }, 1000);
}

function startHintReveal(word) {
  hintRevealInterval = setInterval(() => {
    revealRandomLetter(word);
  }, 10000);
}

function clearIntervals() {
  clearInterval(timerInterval);
  clearInterval(hintRevealInterval);
}

function checkGuess() {
  const userGuess = guessInput.value.trim().toLowerCase();
  if (userGuess === "") {
    messageEl.textContent = "Please enter a guess.";
    return;
  }

  const correctWord = words[currentIndex].word.toLowerCase();

  if (userGuess === correctWord) {
    clearIntervals();
    messageEl.style.color = "#28a745";
    messageEl.textContent = "üéâ Correct!";
    guessInput.disabled = true;
    checkBtn.disabled = true;
    revealBtn.disabled = true;
    nextBtn.disabled = false;
  } else {
    messageEl.style.color = "#d6336c";
    messageEl.textContent = "‚ùå Incorrect. Try again.";
  }
}

function revealAnswer() {
  clearIntervals();
  const currentWord = words[currentIndex].word;
  const tiles = hintTilesEl.children;
  for (let tile of tiles) tile.classList.add("revealed");

  messageEl.style.color = "#d6336c";
  messageEl.textContent = `üîì The answer is "${currentWord}".`;
  guessInput.disabled = true;
  checkBtn.disabled = true;
  revealBtn.disabled = true;
  nextBtn.disabled = false;
}

function nextWord() {
  currentIndex++;
  if (currentIndex >= words.length) {
    definitionEl.textContent = "You've completed all words! üéä";
    hintTilesEl.innerHTML = "";
    guessInput.style.display = "none";
    nextBtn.style.display = "none";
    timerEl.textContent = "";
    messageEl.textContent = "";
    checkBtn.style.display = "none";
    revealBtn.style.display = "none";
  } else {
    showDefinition();
  }
}

// ‚úÖ Enter key triggers check or next
guessInput.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    if (!checkBtn.disabled) checkGuess();
    else if (!nextBtn.disabled) nextWord();
  }
});

loadDictionaryAndStart();
</script>

</body>
</html>
